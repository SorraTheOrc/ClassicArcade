name: Nightly Release

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch: {}

jobs:
  build:
    name: ${{ matrix.os }} build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10"]
    
    env:
      # Mark this run as a production/release build so runtime code can disable
      # worklog creation and other development-only behaviours.
      PRODUCTION: "true"
    
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Determine default branch
      - name: Determine default branch
        id: defbranch
        run: |
          git remote set-head origin -a || true
          default=$(git rev-parse --abbrev-ref origin/HEAD | sed 's|origin/||')
          echo "Default branch detected: $default"
          echo "default_branch=$default" >> $GITHUB_OUTPUT
      
      # Check for recent commits
      - name: Check for recent commits
        id: merge_check
        run: |
          DEFAULT=${{ steps.defbranch.outputs.default_branch }}
          echo "Checking commits to origin/$DEFAULT in the last 24 hours"
          merges=$(git log origin/$DEFAULT --since='24 hours ago' --pretty=format:'%h %ad %s' --date=iso)
          if [ -z "$merges" ]; then
            echo "No commits detected in the last 24 hours. Skipping build."
            echo "no_merges=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Commits detected:"
            echo "$merges"
            echo "no_merges=false" >> $GITHUB_OUTPUT
            echo "merges<<EOF" >> $GITHUB_OUTPUT
            echo "$merges" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade build PyInstaller pytest
      
      # Run tests
      - name: Run tests (pytest)
        id: tests
        run: |
          set -e
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            echo "Running pytest for Python project"
            pytest -q
          else
            echo "No Python project detected â€“ nothing to test"
          fi
      
      # Build executable with PyInstaller
      - name: Build executable with PyInstaller
        id: build
        run: |
          set -e
          pyinstaller --clean classic-arcade.spec
          ls -la dist/
      
      # Prepare tag and release metadata
      - name: Prepare tag and release metadata
        id: tag
        run: |
          set -e
          COMMIT_SHA=$(git rev-parse --verify HEAD)
          SHORT=${COMMIT_SHA:0:7}
          DATE=$(date -u +%Y%m%d)
          TAG=nightly-${DATE}-${SHORT}
          echo "commit=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "short=$SHORT" >> $GITHUB_OUTPUT
          echo "tag prepared: $TAG"
      
      # Create or get GitHub release
      - name: Create or get GitHub release
        if: steps.merge_check.outputs.no_merges != 'true'
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGES: ${{ steps.merge_check.outputs.merges }}
        run: |
          set -euo pipefail
          REPO=${GITHUB_REPOSITORY}
          if [ -z "$TAG" ]; then
            echo "ERROR: TAG is empty" >&2
            exit 1
          fi
          TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]//g')
          echo "Using sanitized TAG: $TAG"
          echo "Creating or locating release for tag: $TAG"
          
          PAYLOAD=$(python3 - <<'PY'
          import json,os
          tag=os.environ['TAG']
          merges=os.environ.get('MERGES','')
          body=f"Automated nightly release for {tag}\n\nMerged commits:\n{merges}"
          data={"tag_name":tag,"name":tag,"body":body,"draft":False,"prerelease":False}
          print(json.dumps(data))
          PY
          )
          
          resp_file=$(mktemp)
          http_code=$(curl -s -w "%{http_code}" -o "$resp_file" -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${REPO}/releases" -d "$PAYLOAD")
          if [ "$http_code" = "201" ]; then
            upload_url=$(python3 -c "import sys,json;print(json.load(open('$resp_file'))['upload_url'])")
            echo "Created release for $TAG"
          elif [ "$http_code" = "422" ]; then
            http_code2=$(curl -s -w "%{http_code}" -o "$resp_file" -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")
            if [ "$http_code2" = "200" ]; then
              upload_url=$(python3 -c "import sys,json;print(json.load(open('$resp_file'))['upload_url'])")
              echo "Found existing release for $TAG"
            else
              echo "Failed to create or find release for $TAG (http $http_code / $http_code2)" >&2
              cat "$resp_file" >&2
              exit 1
            fi
          else
            echo "Failed to create release (http $http_code)" >&2
            cat "$resp_file" >&2
            exit 1
          fi
          
          echo "upload_url=$upload_url" >> $GITHUB_OUTPUT
          rm -f "$resp_file"
      
      # Determine artifact name based on platform
      - name: Determine artifact name
        id: artifact
        run: |
          case "${{ matrix.os }}" in
            windows-latest) EXT="exe" ;;
            macos-latest) EXT="app" ;;
            ubuntu-latest) EXT="appimage" ;;
          esac
          DATE=$(date -u +%Y%m%d)
          COMMIT=${{ steps.tag.outputs.short }}
          ARTIFACT_NAME="ClassicArcade-${DATE}-${COMMIT}-${{ matrix.os }}.${EXT}"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
      
      # Upload release artifact
      - name: Upload release artifact
        if: steps.build.outcome == 'success' && steps.merge_check.outputs.no_merges != 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/ClassicArcade
          asset_name: ${{ steps.artifact.outputs.artifact_name }}
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Done
        run: |
          echo "Build completed for ${{ matrix.os }}"
